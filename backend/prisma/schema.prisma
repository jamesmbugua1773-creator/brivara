generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  username      String   @unique
  passwordHash  String
  referralCode  String   @unique
  sponsorId     String?  
  sponsor       User?    @relation("UserSponsors", fields: [sponsorId], references: [id])
  referrals     User[]   @relation("UserSponsors")
  role          String   @default("USER")
  // Profile fields
  name          String?
  phone         String?
  country       String?
  profileImageUrl String?

  // Account metadata
  status        String   @default("Active")
  created_at    DateTime @default(now())
  lastLogin     DateTime?
  currentPackage String?
  activationDate DateTime?
  updatedAt     DateTime @updatedAt

  // Wallet addresses
  withdraw_wallet_bep20 String?
  deposit_wallet_trc20  String?
  deposit_wallet_bep20  String?

  wallets       Wallet[]
  packages      PackageActivation[]
  points        PointsLedger[]
  bonuses       BonusLedger[]
  rebates       RebateLedger[]
  rois          ROILedger[]
  awards        AwardLedger[]
  withdrawals   Withdrawal[]
  deposits      Deposit[]
  fundings      Funding[]
  tickets       SupportTicket[]
  depositAddresses UserDepositAddress[]

  @@index([email])
  @@index([referralCode])
  @@index([sponsorId])
  @@index([status])
  @@index([created_at])
}

// Note: SQLite connector lacks enum support; using string role

model PackageActivation {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id])
  packageName  String
  amount       Float
  activatedAt  DateTime @default(now())
  cycleCap     Float // 300% of amount
  cycleStatus  String   @default("Active")

  @@index([userId, cycleStatus])
  @@index([activatedAt])
}

model Wallet {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  balance   Float @default(0)
  updatedAt DateTime @updatedAt

  @@unique([userId])
}

model ROILedger {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  packageId     String?
  amount        Float
  timestamp     DateTime @default(now())
  txId          String   @unique
}

model BonusLedger {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  sourceUserId  String
  level         Int
  type          String   // DIRECT or INDIRECT
  amount        Float
  timestamp     DateTime @default(now())
  txId          String   @unique
}

model PointsLedger {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  sourceUserId  String
  level         Int
  points        Float
  timestamp     DateTime @default(now())
  txId          String   @unique
}

model RebateLedger {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  sourceUserId  String
  level         Int
  pointsUsed    Float
  amount        Float
  timestamp     DateTime @default(now())
  txId          String   @unique
}

model AwardLedger {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id])
  awardName    String
  packageName  String
  packageAmount Float
  timestamp    DateTime @default(now())
  txId         String   @unique
}

model Deposit {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  amount    Float
  fee       Float    @default(0)
  network   String   // SYSTEM, TRC20 or BEP20

  @@index([userId, status])
  @@index([status, timestamp])
  @@index([txId])
  @@index([network])
  txId      String   @unique
  timestamp DateTime @default(now())
  status    String   @default("Pending")
}

model Funding {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  amount        Float    // Loan amount provided
  totalEarned   Float    @default(0) // Total earnings from funded amount
  requiredReturn Float   // 3x the funded amount
  status        String   @default("Active") // Active, Repaid, Defaulted
  fundedAt      DateTime @default(now())
  repaidAt      DateTime?
  txId          String   @unique
}

model Withdrawal {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  amount    Float
  fee       Float

  @@index([userId, status])
  @@index([status, timestamp])
  @@index([txId])
  network   String   // BEP20 only
  source    String   @default("REBATE") // REBATE | REFERRAL | AWARDS | FUNDING
  txId      String   @unique
  timestamp DateTime @default(now())
  status    String   @default("Pending")
}

model SupportTicket {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  category  String   // DEPOSIT or GENERAL
  subject   String
  message   String
  status    String   @default("OPEN") // OPEN or CLOSED
  adminReply String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model UserDepositAddress {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  network   String   // TRC20 or BEP20
  address   String   @unique
  createdAt DateTime @default(now())

  @@unique([userId, network])
}
